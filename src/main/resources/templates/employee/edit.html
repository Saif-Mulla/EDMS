<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Edit Employee</title>
  <style>
    body { font-family: sans-serif; margin: 1.5rem; }
    .row { margin-bottom: .6rem; }
    label { display: inline-block; width: 140px; }
    input, select { padding: .3rem; width: 260px; }
    .btn { padding: .4rem .6rem; border: 1px solid #888; background: #f5f5f5; cursor: pointer; }
    .addr { border: 1px solid #ddd; padding: .8rem; margin: .6rem 0; }
  </style>
</head>
<body>

<h2 th:text="'Edit Employee - ' + ${employee.employeeId}">Edit</h2>
<form th:action="@{|/api/employee/${employee.employeeId}|}" th:object="${employee}" method="post">

  <div class="row">
    <label>Employee ID</label>
    <input th:field="*{employeeId}" readonly/>
  </div>

  <div class="row"><label>First Name</label><input th:field="*{firstName}"/></div>
  <div class="row"><label>Middle Name</label><input th:field="*{middleName}"/></div>
  <div class="row"><label>Last Name</label><input th:field="*{lastName}"/></div>
  <div class="row"><label>Designation</label><input th:field="*{designation}"/></div>
  <div class="row"><label>Department</label><input th:field="*{department}"/></div>

  <h3>Addresses</h3>
  <div id="addresses">
    <div class="addr" th:each="a,iter : *{addresses}">
      <div class="row">
        <label>Type</label>
        <select th:field="*{addresses[__${iter.index}__].addressType}">
          <option th:each="t : ${addressTypes}" th:value="${t}" th:text="${t}">PRIMARY</option>
        </select>
      </div>
      <div class="row"><label>Address 1</label><input th:field="*{addresses[__${iter.index}__].address1}"/></div>
      <div class="row"><label>Address 2</label><input th:field="*{addresses[__${iter.index}__].address2}"/></div>
      <div class="row"><label>Postal Code</label><input th:field="*{addresses[__${iter.index}__].postalCode}"/></div>
      <button type="button" class="btn" onclick="removeAddress(this)">Remove</button>
    </div>
  </div>

  <button type="button" class="btn" onclick="addAddress()">+ Add Address</button>
  <div style="margin-top:1rem">
    <button class="btn" type="submit">Update</button>
    <a class="btn" th:href="@{/api/employee}">Cancel</a>
  </div>
</form>

<template id="addrTemplate">
  <div class="addr">
    <div class="row">
      <label>Type</label>
      <select class="address-type-select" name="addresses[__idx__].addressType">
        <option value="PRIMARY">PRIMARY</option>
        <option value="SECONDARY">SECONDARY</option>
      </select>
    </div>
    <div class="row"><label>Address 1</label><input name="addresses[__idx__].address1"/></div>
    <div class="row"><label>Address 2</label><input name="addresses[__idx__].address2"/></div>
    <div class="row"><label>Postal Code</label><input name="addresses[__idx__].postalCode"/></div>
    <button type="button" class="btn" onclick="removeAddress(this)">Remove</button>
  </div>
</template>

<script>
  // --- Helpers ---
  function $all(sel, ctx=document){ 
	return Array.from(ctx.querySelectorAll(sel)); 

  }
  function countPrimary(){
    return $all('.address-type-select')
      .filter(s => (s.value || '').toUpperCase() === 'PRIMARY').length;
  }

  function attachSelectHandlers(ctx=document){
    $all('.address-type-select', ctx).forEach(sel => {
      // prevent duplicate listeners if re-attached
      sel.removeEventListener('change', onTypeChange);
      sel.addEventListener('change', onTypeChange);
    });
  }

  function onTypeChange(e){
    const totalPrimary = countPrimary();
    if (totalPrimary > 1){
      // revert this selection to SECONDARY and warn
      e.target.value = 'SECONDARY';
      alert('Only one PRIMARY address is allowed.');
    }
  }

  // --- Add / Remove rows ---
  function nextIndex(){
    return document.querySelectorAll('#addresses .addr').length;
  }

  function addAddress(){
    const tpl = document.getElementById('addrTemplate').innerHTML;
    const idx = nextIndex();
    const html = tpl.replaceAll('__idx__', idx);
    const container = document.getElementById('addresses');
    container.insertAdjacentHTML('beforeend', html);

    // ensure the new select exists and gets a handler
    const newBlock = container.lastElementChild;
    const sel = newBlock.querySelector('.address-type-select');

    // If a PRIMARY already exists, default new one to SECONDARY
    if (countPrimary() >= 1) {
      sel.value = 'SECONDARY';
    } else {
      sel.value = 'PRIMARY';
    }
    attachSelectHandlers(newBlock);
  }

  function removeAddress(btn){
    const box = btn.closest('.addr');
    box.remove();
    // After removal, nothing else to doâ€”if user removed the PRIMARY,
    // they can set another one; if multiple PRIMARY existed, removal fixes it.
  }

  // --- Block submit if rule violated ---
  function onSubmit(e){
    if (countPrimary() > 1){
      e.preventDefault();
      alert('Only one PRIMARY address is allowed. Please adjust the Address Type.');
      return false;
    }
    // If you want to require at least one PRIMARY, uncomment below:
    // if (countPrimary() === 0) {
    //   e.preventDefault();
    //   alert('Please select one PRIMARY address.');
    //   return false;
    // }
  }

  // --- Init ---
  document.addEventListener('DOMContentLoaded', function(){
    attachSelectHandlers();
    document.getElementById('empForm').addEventListener('submit', onSubmit);

    // If the server rendered multiple PRIMARY by mistake, normalize: keep the first PRIMARY, flip others to SECONDARY
    const primarySelects = $all('.address-type-select')
      .filter(s => (s.value || '').toUpperCase() === 'PRIMARY');
    for (let i = 1; i < primarySelects.length; i++){
      primarySelects[i].value = 'SECONDARY';
    }
  });
</script>
</body>
</html>
